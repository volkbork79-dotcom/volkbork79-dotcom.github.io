<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üìù –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Äî ShopDrive</title>
    <link rel="icon" href="/favicon.ico" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #121212;
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
        }
        .card {
            background: #1e1e1e;
            width: 100%;
            max-width: 420px;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
        }
        h1 {
            text-align: center;
            margin-bottom: 24px;
            color: #e83f6f;
            font-size: 1.6rem;
        }
        p {
            text-align: center;
            color: #aaa;
            margin-bottom: 24px;
            font-size: 0.95rem;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
            font-size: 0.95rem;
        }
        input[type="text"],
        input[type="email"],
        input[type="password"] {
            width: 100%;
            padding: 14px;
            border: 1px solid #444;
            border-radius: 8px;
            background: #2c2c2c;
            color: white;
            font-size: 1rem;
        }
        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: #e83f6f;
            box-shadow: 0 0 0 2px rgba(232, 63, 111, 0.25);
        }
        .btn {
            width: 100%;
            padding: 14px;
            background: #e83f6f;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
        }
        .btn:hover {
            background: #d0305a;
        }
        .back-link {
            display: block;
            text-align: center;
            margin-top: 20px;
            color: #aaa;
            text-decoration: none;
            font-size: 0.95rem;
        }
        .back-link:hover {
            color: #e83f6f;
        }
    </style>
</head>
<body>

    <div class="card">
        <h1>–í—Ö–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
        <p>–î–µ–ª–∏—Ç–µ—Å—å –ø–æ–∫—É–ø–∫–∞–º–∏ —Å –¥—Ä—É–≥–∏–º–∏ —à–æ–ø–æ–≥–æ–ª–∏–∫–∞–º–∏</p>

        <form id="authForm">
            <div class="form-group">
                <label for="name">–í–∞—à–µ –∏–º—è</label>
                <input type="text" id="name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–Ω–Ω–∞" required>
            </div>

            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="–≤–∞—à@email.com" required>
            </div>

            <div class="form-group">
                <label for="password">–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="password" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" required>
            </div>

            <div class="form-group">
                <label for="avatar">–ê–≤–∞—Ç–∞—Ä–∫–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <input type="file" id="avatar" accept="image/*">
            </div>

            <button type="submit" class="btn">–í–æ–π—Ç–∏ / –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </form>

        <a href="index.html" class="back-link">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://ipgnloapdoamwylhckbn.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwZ25sb2FwZG9hbXd5bGhja2JuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MzIzNTEsImV4cCI6MjA4NzMwODM1MX0.-xY6th1M1tBfB2eyFaPSxWcqb8yRxpXkB-riOfoC2-c';

        // –°–æ–∑–¥–∞—ë–º –∫–ª–∏–µ–Ω—Ç
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

        document.getElementById("authForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const name = document.getElementById("name").value.trim();
            const email = document.getElementById("email").value.trim();
            const password = document.getElementById("password").value;
            const file = document.getElementById("avatar").files[0];

            if (password.length < 6) {
                alert("–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤");
                return;
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è
            localStorage.setItem('userName', name);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–≤–∞—Ç–∞—Ä–∫–∏
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    localStorage.setItem('userAvatar', e.target.result);
                    await trySignInOrUp(email, password);
                };
                reader.readAsDataURL(file);
            } else {
                localStorage.setItem('userAvatar', 'https://via.placeholder.com/40x40/f8d7da/ffffff?text=üë§');
                await trySignInOrUp(email, password);
            }
        });

        // –§—É–Ω–∫—Ü–∏—è: –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤–æ–π—Ç–∏, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è ‚Äî –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å
        async function trySignInOrUp(email, password) {
            try {
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –≤–æ–π—Ç–∏
                const { data: signInData, error: signInError } = await supabaseClient.auth.signInWithPassword({ email, password });

                if (signInData) {
                    console.log("‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥", signInData);
                    alert("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ!");
                    localStorage.setItem('isGuest', 'false');
                    window.location.href = "profile.html";
                    return;
                }

                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ ‚Äî –ø—Ä–æ–±—É–µ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                if (signInError && signInError.message.includes("Invalid login credentials")) {
                    const { data: signUpData, error: signUpError } = await supabaseClient.auth.signUp({ email, password });

                    if (signUpError) {
                        if (signUpError.message.includes("rate limit")) {
                            alert("–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–π email, –Ω–∞–ø—Ä–∏–º–µ—Ä: test+1@gmail.com");
                        } else {
                            alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + signUpError.message);
                        }
                        return;
                    }

                    alert("‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!");
                    localStorage.setItem('isGuest', 'false');
                    window.location.href = "profile.html";
                } else {
                    alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + signInError.message);
                }
            } catch (err) {
                console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", err);
                alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: " + err.message);
            }
        }
    </script>
</body>
</html>